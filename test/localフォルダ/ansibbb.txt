#!/bin/bash
sudo yum install -y https://s3.ap-northeast-1.amazonaws.com/amazon-ssm-ap-northeast-1/latest/linux_amd64/amazon-ssm-agent.rpm
sudo pip3 install --upgrade pip setuptools



---
- name: modify efs-utils.conf
  lineinfile: 
    dest='/etc/amazon/efs/efs-utils.conf'
    state=present
    backrefs=yes
    regexp='{{ item.regexp }}'
    line='{{ item.line }}'
  with_items:
  - regexp: '^stunnel_check_cert_hostname = true'
    line: 'stunnel_check_cert_hostname = false'



- name: mount efs volume
  mount:
    path: "/home/ec2-user/{{ efs_vol_name }}"
    src: "{{ _efs_fact_id }}.efs.ap-northeast-1.amazonaws.com:/"
    fstype: "nfs4"
    opts: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport"
    state: mounted